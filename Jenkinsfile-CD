pipeline {
    agent any
    options {
        buildDiscarder(logRotator(numToKeepStr: '5'))
    }
    environment {
        REPO_URL = 'https://github.com/22127063/spring-petclinic-microservices.git'
        DEPLOY_PATH = 'k8s/deployment'
        SERVICES_WITHOUT_TESTS = "spring-petclinic-admin-server spring-petclinic-genai-service"
        NAMESPACE = 'petclinic'
    }

    parameters {
        string(name: 'CUSTOMERS_BRANCH', defaultValue: 'main', description: 'Branch for customers-service')
        string(name: 'VISITS_BRANCH', defaultValue: 'main', description: 'Branch for visits-service')
        string(name: 'VETS_BRANCH', defaultValue: 'main', description: 'Branch for vets-service')
        string(name: 'GENAI_BRANCH', defaultValue: 'main', description: 'Branch for genai-service')
        choice(name: 'TARGET_SERVICE', choices: ['customers', 'visits', 'vets', 'genai'], description: 'Service to deploy from feature branch')
    }

    stages {
        stage('Checkout Code') {
            steps {
                script {
                    sh '''
                    if [ ! -d spring-petclinic-microservices ]; then
                        git clone https://github.com/22127063/spring-petclinic-microservices.git
                    fi
                    cd spring-petclinic-microservices
                    git reset --hard HEAD
                    git pull origin main
                    '''
                }
            }
        }

        stage('Detect Changes') {
            steps {
                script {
                    echo "Running pipeline for Branch: ${env.BRANCH_NAME}"

                    def prevCommitExists = sh(script: "cd spring-petclinic-microservices && git rev-parse HEAD~1", returnStatus: true) == 0
                    def changedFiles = prevCommitExists 
                        ? sh(script: "cd spring-petclinic-microservices && git diff --name-only HEAD~1 HEAD", returnStdout: true).trim().split("\n")
                        : []

                    def services = [
                        'spring-petclinic-admin-server',
                        'spring-petclinic-api-gateway',
                        'spring-petclinic-config-server',
                        'spring-petclinic-customers-service',
                        'spring-petclinic-discovery-server',
                        'spring-petclinic-genai-service',
                        'spring-petclinic-vets-service',
                        'spring-petclinic-visits-service'
                    ]

                    def changedServiceList = services.findAll { service ->
                        changedFiles.any { it.contains(service) }
                    }

                    def commonFiles = ["pom.xml", ".github", "docker-compose.yml", "Jenkinsfile-CI", "Jenkinsfile-CD", "Dockerfile"]
                    if (changedFiles.any { file -> commonFiles.any { file.contains(it) } }) {
                        changedServiceList = services
                    }

                    env.CHANGED_SERVICES = changedServiceList.join(" ")

                    if (env.CHANGED_SERVICES.trim().isEmpty()) {
                        echo "No relevant changes detected. Skipping pipeline."
                        currentBuild.result = 'SUCCESS'
                        return
                    }

                    echo "Services to build: ${env.CHANGED_SERVICES}"
                }
            }
        }

        stage('Checkout Deployment Code') {
            steps {
                script {
                    if (!fileExists('spring-petclinic-microservices')) {
                        sh "git clone ${REPO_URL}"
                    }

                    dir('spring-petclinic-microservices') {
                        sh 'git reset --hard HEAD && git checkout main && git pull origin main'
                    }
                }
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                script {
                    def branches = [
                        'customers': params.CUSTOMERS_BRANCH,
                        'visits'   : params.VISITS_BRANCH,
                        'vets'     : params.VETS_BRANCH,
                        'genai'    : params.GENAI_BRANCH
                    ]

                    def services = ['customers', 'visits', 'vets', 'genai']

                    for (svc in services) {
                        def branch = (svc == params.TARGET_SERVICE) ? branches[svc] : "main"
                        def repoPath = "spring-petclinic-microservices/spring-petclinic-${svc}-service"

                        sh "cd ${repoPath} && git fetch origin ${branch}"

                        def commitId = sh(
                            script: "cd ${repoPath} && git rev-parse --short origin/${branch}",
                            returnStdout: true
                        ).trim()

                        def tag = (branch != 'main') ? "-${branch}" : ""
                        def imageTag = "22127063/spring-petclinic-${svc}-service:${commitHash}"

                        echo "ðŸš€ Deploying ${svc}-service with image: ${imageTag}"

                        def yamlPath = "spring-petclinic-microservices/${DEPLOY_PATH}/${svc}.yaml"

                        // ðŸ”¹ Ensure namespace exists
                        sh """
                            kubectl get namespace ${NAMESPACE} || kubectl create namespace ${NAMESPACE}
                        """

                        // Replace image inline using sed
                        sh """
                            sed -i 's|image: .*|image: ${imageTag}|' ${yamlPath}
                            kubectl apply -f ${yamlPath}
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
